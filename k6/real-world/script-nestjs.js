import http from "k6/http";
import { check, sleep } from "k6";
import { Counter } from "k6/metrics";

const COUNTRIES = [
  "United States",
  "Canada",
  "India",
  "Afghanistan",
  "Albania",
  "Algeria",
  "Andorra",
  "Angola",
  "Antigua and Barbuda",
  "Argentina",
  "Armenia",
  "Australia",
  "Austria",
  "Azerbaijan",
  "Bahamas",
  "Bahrain",
  "Bangladesh",
  "Barbados",
  "Belarus",
  "Belgium",
  "Belize",
  "Benin",
  "Bermuda",
  "Bhutan",
  "Bolivia, Plurinational State of",
  "Bosnia and Herzegovina",
  "Botswana",
  "Brazil",
  "Brunei Darussalam",
  "Bulgaria",
  "Burkina Faso",
  "Myanmar",
  "Burundi",
  "Cambodia",
  "Cameroon",
  "Cape Verde",
  "Cayman Islands",
  "Central African Republic",
  "Chad",
  "Chile",
  "China",
  "Colombia",
  "Congo, the Democratic Republic of the",
  "Congo",
  "Costa Rica",
  "Côte d'Ivoire",
  "Iran",
  "Poland",
  "Croatia",
  "Cuba",
  "Cyprus",
  "Czech Republic",
  "Denmark",
  "Djibouti",
  "Dominica",
  "Dominican Republic",
  "Ecuador",
  "Egypt",
  "El Salvador",
  "Equatorial Guinea",
  "Eritrea",
  "Estonia",
  "Ethiopia",
  "Faroe Islands",
  "Fiji",
  "Finland",
  "France",
  "French Guiana",
  "French Polynesia",
  "Gabon",
  "Gambia",
  "Georgia",
  "Germany",
  "Ghana",
  "Greece",
  "Greenland",
  "Grenada",
  "Guadeloupe",
  "Guam",
  "Guatemala",
  "Guinea",
  "Guyana",
  "Haiti",
  "Holy See (Vatican City State)",
  "Honduras",
  "Hong Kong",
  "Hungary",
  "Iceland",
  "Indonesia",
  "Iraq",
  "Ireland",
  "Israel",
  "Italy",
  "Jamaica",
  "Japan",
  "Jordan",
  "Kazakhstan",
  "Kenya",
  "Korea, Democratic People's Republic of",
  "Korea, Republic of",
  "Kosovo",
  "Kuwait",
  "Kyrgyzstan",
  "Lao People's Democratic Republic",
  "Latvia",
  "Lebanon",
  "Lesotho",
  "Liberia",
  "Libya",
  "Liechtenstein",
  "Lithuania",
  "Luxembourg",
  "Macao",
  "Macedonia, the Former Yugoslav Republic of",
  "Madagascar",
  "Malawi",
  "Malaysia",
  "Maldives",
  "Mali",
  "Malta",
  "Martinique",
  "Mauritania",
  "Mauritius",
  "Mexico",
  "Moldova, Republic of",
  "Monaco",
  "Mongolia",
  "Montenegro",
  "Montserrat",
  "Morocco",
  "Mozambique",
  "Namibia",
  "Nepal",
  "Netherlands",
  "New Caledonia",
  "New Zealand",
  "Nicaragua",
  "Niger",
  "Nigeria",
  "Niue",
  "Norway",
  "Oman",
  "Pakistan",
  "Palestine, State of",
  "Panama",
  "Papua New Guinea",
  "Paraguay",
  "Peru",
  "Philippines",
  "Portugal",
  "Puerto Rico",
  "Qatar",
  "Réunion",
  "Romania",
  "Russian Federation",
  "Rwanda",
  "Saint Kitts and Nevis",
  "Saint Lucia",
  "Saint Vincent and the Grenadines",
  "Samoa",
  "San Marino",
  "Saudi Arabia",
  "Senegal",
  "Serbia",
  "Seychelles",
  "Sierra Leone",
  "Singapore",
  "Slovakia",
  "Slovenia",
  "Solomon Islands",
  "Somalia",
  "South Africa",
  "South Sudan",
  "Spain",
  "Sri Lanka",
  "Sudan",
  "Suriname",
  "Swaziland",
  "Sweden",
  "Switzerland",
  "Syrian Arab Republic",
  "Taiwan",
  "Tajikistan",
  "Tanzania, United Republic of",
  "Thailand",
  "Togo",
  "Tonga",
  "Trinidad and Tobago",
  "Tunisia",
  "Turkey",
  "Turkmenistan",
  "Turks and Caicos Islands",
  "Uganda",
  "Ukraine",
  "United Arab Emirates",
  "United Kingdom",
  "Uruguay",
  "Uzbekistan",
  "Venezuela, Bolivarian Republic of",
  "Viet Nam",
  "Virgin Islands, British",
  "Yemen",
  "Zambia",
  "Zimbabwe",
  "Vietnam",
];

const BOOK_REFS = [
  { book_ref: "000004" },
  { book_ref: "00000F" },
  { book_ref: "000010" },
  { book_ref: "000012" },
  { book_ref: "000026" },
  { book_ref: "00002D" },
  { book_ref: "000034" },
  { book_ref: "00003F" },
  { book_ref: "000048" },
  { book_ref: "00004A" },
  { book_ref: "000050" },
  { book_ref: "000055" },
  { book_ref: "000061" },
  { book_ref: "000067" },
  { book_ref: "000068" },
  { book_ref: "00006A" },
  { book_ref: "00006B" },
  { book_ref: "00007A" },
  { book_ref: "00007C" },
  { book_ref: "00007D" },
  { book_ref: "00008F" },
  { book_ref: "000090" },
  { book_ref: "000099" },
  { book_ref: "0000B0" },
  { book_ref: "0000B3" },
  { book_ref: "0000C8" },
  { book_ref: "0000C9" },
  { book_ref: "0000CD" },
  { book_ref: "0000D0" },
  { book_ref: "0000D9" },
  { book_ref: "0000E0" },
  { book_ref: "0000E2" },
  { book_ref: "0000EF" },
  { book_ref: "0000FB" },
  { book_ref: "0000FE" },
  { book_ref: "000101" },
  { book_ref: "000103" },
  { book_ref: "000104" },
  { book_ref: "000112" },
  { book_ref: "000137" },
  { book_ref: "00013C" },
  { book_ref: "000146" },
  { book_ref: "00014B" },
  { book_ref: "000151" },
  { book_ref: "000155" },
  { book_ref: "00015C" },
  { book_ref: "00015D" },
  { book_ref: "000161" },
  { book_ref: "000178" },
  { book_ref: "00017E" },
  { book_ref: "000181" },
  { book_ref: "000184" },
  { book_ref: "000186" },
  { book_ref: "000197" },
  { book_ref: "000198" },
  { book_ref: "00019E" },
  { book_ref: "0001B2" },
  { book_ref: "0001BB" },
  { book_ref: "0001CE" },
  { book_ref: "0001CF" },
  { book_ref: "0001D1" },
  { book_ref: "0001D3" },
  { book_ref: "000204" },
  { book_ref: "000207" },
  { book_ref: "00020B" },
  { book_ref: "00020C" },
  { book_ref: "000210" },
  { book_ref: "00021E" },
  { book_ref: "000229" },
  { book_ref: "000239" },
  { book_ref: "000244" },
  { book_ref: "000246" },
  { book_ref: "000247" },
  { book_ref: "000249" },
  { book_ref: "00024B" },
  { book_ref: "000253" },
  { book_ref: "000255" },
  { book_ref: "000258" },
  { book_ref: "00025B" },
  { book_ref: "000260" },
  { book_ref: "000271" },
  { book_ref: "000277" },
  { book_ref: "000287" },
  { book_ref: "00028E" },
  { book_ref: "0002A0" },
  { book_ref: "0002A7" },
  { book_ref: "0002AB" },
  { book_ref: "0002AD" },
  { book_ref: "0002B2" },
  { book_ref: "0002B5" },
  { book_ref: "0002C2" },
  { book_ref: "0002CD" },
  { book_ref: "0002D8" },
  { book_ref: "0002DB" },
  { book_ref: "0002DF" },
  { book_ref: "0002E0" },
  { book_ref: "0002E6" },
  { book_ref: "0002F0" },
  { book_ref: "0002F3" },
  { book_ref: "0002F8" },
  { book_ref: "0002F9" },
  { book_ref: "00030F" },
  { book_ref: "000317" },
  { book_ref: "00031C" },
  { book_ref: "000321" },
  { book_ref: "000335" },
  { book_ref: "00033C" },
  { book_ref: "00033F" },
  { book_ref: "000342" },
  { book_ref: "00034E" },
  { book_ref: "000352" },
  { book_ref: "000353" },
  { book_ref: "00035B" },
  { book_ref: "000368" },
  { book_ref: "00036F" },
  { book_ref: "000374" },
  { book_ref: "000376" },
  { book_ref: "000391" },
  { book_ref: "00039F" },
  { book_ref: "0003A8" },
  { book_ref: "0003BB" },
  { book_ref: "0003C7" },
  { book_ref: "0003C9" },
  { book_ref: "0003D0" },
  { book_ref: "0003D4" },
  { book_ref: "0003E5" },
  { book_ref: "0003EF" },
  { book_ref: "00040C" },
  { book_ref: "00041E" },
  { book_ref: "000447" },
  { book_ref: "00044D" },
  { book_ref: "00044E" },
  { book_ref: "000456" },
  { book_ref: "000469" },
  { book_ref: "00046B" },
  { book_ref: "000473" },
  { book_ref: "000475" },
  { book_ref: "000479" },
  { book_ref: "00047B" },
  { book_ref: "000485" },
  { book_ref: "000496" },
  { book_ref: "00049A" },
  { book_ref: "00049D" },
  { book_ref: "0004AD" },
  { book_ref: "0004AE" },
  { book_ref: "0004B0" },
  { book_ref: "0004B5" },
  { book_ref: "0004B9" },
  { book_ref: "0004BC" },
  { book_ref: "0004C1" },
  { book_ref: "0004CA" },
  { book_ref: "0004CB" },
  { book_ref: "0004CF" },
  { book_ref: "0004E1" },
  { book_ref: "0004E3" },
  { book_ref: "0004E7" },
  { book_ref: "0004F0" },
  { book_ref: "0004F9" },
  { book_ref: "0004FC" },
  { book_ref: "000500" },
  { book_ref: "000511" },
  { book_ref: "000518" },
  { book_ref: "00051A" },
  { book_ref: "000521" },
  { book_ref: "000532" },
  { book_ref: "000533" },
  { book_ref: "00053F" },
  { book_ref: "000547" },
  { book_ref: "000548" },
  { book_ref: "000549" },
  { book_ref: "00054E" },
  { book_ref: "000557" },
  { book_ref: "000558" },
  { book_ref: "00055B" },
  { book_ref: "000572" },
  { book_ref: "000579" },
  { book_ref: "000580" },
  { book_ref: "000591" },
  { book_ref: "000595" },
  { book_ref: "00059C" },
  { book_ref: "0005A0" },
  { book_ref: "0005AB" },
  { book_ref: "0005B2" },
  { book_ref: "0005B6" },
  { book_ref: "0005BE" },
  { book_ref: "0005D1" },
  { book_ref: "0005D2" },
  { book_ref: "0005D4" },
  { book_ref: "0005E2" },
  { book_ref: "0005E7" },
  { book_ref: "0005EC" },
  { book_ref: "0005F4" },
  { book_ref: "0005F7" },
  { book_ref: "0005F8" },
  { book_ref: "0005FF" },
  { book_ref: "00061C" },
  { book_ref: "00061E" },
  { book_ref: "000621" },
  { book_ref: "00062C" },
  { book_ref: "000635" },
];

function getRandomInt(min, max) {
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

export let options = {
  stages: [
    { duration: "1m", target: 100 },
    { duration: "2m", target: 100 },
    { duration: "1m", target: 0 },
  ],
};
const sleepTime = 0.5;

const errorCount = new Counter("req_failed_count");

export default function () {
  // Token expires by 8.3.2025
  /* 
    Generate new one in this format:
    {
        "iss": "Microservice Framework Performance Comparison",
        "iat": 1614952910,
        "exp": 1741425801,
        "aud": "www.example.com",
        "sub": "dummy@user.foo",
        "username": "admin"
    }
    With key MicroserviceFrameworkComparisonKey
  */
  const params = {
    headers: {
      Authorization:
        "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJNaWNyb3NlcnZpY2UgRnJhbWV3b3JrIFBlcmZvcm1hbmNlIENvbXBhcmlzb24iLCJpYXQiOjE2MTQ5NTI5MTAsImV4cCI6MTc0MTQyNTgwMSwiYXVkIjoid3d3LmV4YW1wbGUuY29tIiwic3ViIjoiZHVtbXlAdXNlci5mb28iLCJ1c2VybmFtZSI6ImFkbWluIn0.tPWhOenwzj5GkKg0PdFIj4HtXfVirwei8YUl5XThbFA",
    },
  };

  let res = http.get(
    `http://localhost:3000/tickets?book_ref=${encodeURI(
      BOOK_REFS[getRandomInt(0, BOOK_REFS.length - 1)].book_ref
    )}`,
    params
  );

  if (
    !check(res, {
      "is status 200": (r) => r.status === 200,
    })
  ) {
    errorCount.add(1);
  }

  sleep(sleepTime);
}

export function handleSummary(data) {
  console.log("Preparing the end-of-test summary...");

  return {
    "nestjs/k6-summary.json": JSON.stringify(data),
  };
}
